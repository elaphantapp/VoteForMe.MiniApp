<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="./js/vue.min.js"></script>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="./js/lodash.min.js"></script>
    <script src="./js/vue-clipboard.min.js"></script>
    <script src="./js/vue-datepicker.min.js"></script>
    <script>
        Vue.use(DatePicker)
    </script>
    <script>
        var sha256 = function sha256(ascii) {
            function rightRotate(value, amount) {
                return (value >>> amount) | (value << (32 - amount));
            };

            var mathPow = Math.pow;
            var maxWord = mathPow(2, 32);
            var lengthProperty = 'length'
            var i, j; // Used as a counter across the whole file
            var result = ''

            var words = [];
            var asciiBitLength = ascii[lengthProperty] * 8;

            //* caching results is optional - remove/add slash from front of this line to toggle
            // Initial hash value: first 32 bits of the fractional parts of the square roots of the first 8 primes
            // (we actually calculate the first 64, but extra values are just ignored)
            var hash = sha256.h = sha256.h || [];
            // Round constants: first 32 bits of the fractional parts of the cube roots of the first 64 primes
            var k = sha256.k = sha256.k || [];
            var primeCounter = k[lengthProperty];
            /*/
            var hash = [], k = [];
            var primeCounter = 0;
            //*/

            var isComposite = {};
            for (var candidate = 2; primeCounter < 64; candidate++) {
                if (!isComposite[candidate]) {
                    for (i = 0; i < 313; i += candidate) {
                        isComposite[i] = candidate;
                    }
                    hash[primeCounter] = (mathPow(candidate, .5) * maxWord) | 0;
                    k[primeCounter++] = (mathPow(candidate, 1 / 3) * maxWord) | 0;
                }
            }

            ascii += '\x80' // Append Ƈ' bit (plus zero padding)
            while (ascii[lengthProperty] % 64 - 56) ascii += '\x00' // More zero padding
            for (i = 0; i < ascii[lengthProperty]; i++) {
                j = ascii.charCodeAt(i);
                if (j >> 8) return; // ASCII check: only accept characters in range 0-255
                words[i >> 2] |= j << ((3 - i) % 4) * 8;
            }
            words[words[lengthProperty]] = ((asciiBitLength / maxWord) | 0);
            words[words[lengthProperty]] = (asciiBitLength)

            // process each chunk
            for (j = 0; j < words[lengthProperty];) {
                var w = words.slice(j, j += 16); // The message is expanded into 64 words as part of the iteration
                var oldHash = hash;
                // This is now the undefinedworking hash", often labelled as variables a...g
                // (we have to truncate as well, otherwise extra entries at the end accumulate
                hash = hash.slice(0, 8);

                for (i = 0; i < 64; i++) {
                    var i2 = i + j;
                    // Expand the message into 64 words
                    // Used below if 
                    var w15 = w[i - 15],
                        w2 = w[i - 2];

                    // Iterate
                    var a = hash[0],
                        e = hash[4];
                    var temp1 = hash[7] +
                        (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25)) // S1
                        +
                        ((e & hash[5]) ^ ((~e) & hash[6])) // ch
                        +
                        k[i]
                        // Expand the message schedule if needed
                        +
                        (w[i] = (i < 16) ? w[i] : (
                            w[i - 16] +
                            (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15 >>> 3)) // s0
                            +
                            w[i - 7] +
                            (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2 >>> 10)) // s1
                        ) | 0);
                    // This is only used once, so *could* be moved below, but it only saves 4 bytes and makes things unreadble
                    var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22)) // S0
                        +
                        ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2])); // maj

                    hash = [(temp1 + temp2) | 0].concat(hash); // We don't bother trimming off the extra ones, they're harmless as long as we're truncating when we do the slice()
                    hash[4] = (hash[4] + temp1) | 0;
                }

                for (i = 0; i < 8; i++) {
                    hash[i] = (hash[i] + oldHash[i]) | 0;
                }
            }

            for (i = 0; i < 8; i++) {
                for (j = 3; j + 1; j--) {
                    var b = (hash[i] >> (j * 8)) & 255;
                    result += ((b < 16) ? 0 : '') + b.toString(16);
                }
            }
            return result;
        };
        Vue.prototype.$sha256 = sha256;
    </script>
    <link rel="stylesheet" type="text/css" href="./css/reset.css">
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
</head>
<style type="text/css">
    body {
        background: #F2F9FF;
    }
    
    .xiaoshuo {
        cursor: pointer;
    }
    
    .create {
        width: 232px;
        margin: 0 auto;
    }
    
    .create p {
        width: 232px;
        height: 54px;
        line-height: 54px;
        background: #0070C8;
        border: 1px solid #BDDBFF;
        box-sizing: border-box;
        border-radius: 5px;
        text-align: center;
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        font-size: 16px;
        color: #FFFFFF;
    }
    
    .xiaoshuo {
        cursor: pointer;
    }
    
    .hang {
        margin: 10px 0px;
        text-align: center;
    }
    
    .hang input {
        width: 300px;
        padding-left: 10px;
        height: 40px;
    }
    
    .hang select {
        width: 300px;
        padding-left: 10px;
        padding-right: 14px;
        height: 40px;
        appearance: none;
        -moz-appearance: none;
        -webkit-appearance: none;
    }
    
    .hang1 {
        margin: 10px 0px;
        text-align: center;
    }
    
    .hang1 .left {
        width: 80px;
        padding-left: 10px;
        height: 40px;
        border: 0;
    }
    
    .hang1 .right {
        width: 160px;
        padding-left: 10px;
        height: 40px;
        border: 0;
    }
    
    .hang1 span {
        display: inline-block;
        width: 60px;
        height: 40px;
        line-height: 40px;
        background: #0070C8;
        border: 1px solid #BDDBFF;
        box-sizing: border-box;
        border-radius: 5px;
        text-align: center;
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        font-size: 16px;
        color: #FFFFFF;
    }
    
    .hang2 {
        margin: 10px 0px;
        text-align: center;
    }
    
    .hang2 .left {
        display: inline-block;
        width: 120px;
        height: 40px;
        line-height: 40px;
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        font-size: 16px;
        background: #FFFFFF;
        color: inherit;
    }
    
    .hang2 .middle {
        display: inline-block;
        width: 120px;
        height: 40px;
        line-height: 40px;
        box-sizing: border-box;
        border-radius: 5px;
        text-align: center;
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        font-size: 16px;
        background: #FFFFFF;
        color: inherit;
    }
    
    .hang2 .right {
        display: inline-block;
        width: 60px;
        height: 40px;
        line-height: 40px;
        background: #0070C8;
        border: 1px solid #BDDBFF;
        box-sizing: border-box;
        border-radius: 5px;
        text-align: center;
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        font-size: 16px;
        color: #FFFFFF;
    }
    
    .hang3 {
        margin-top: 50px;
        text-align: center;
    }
    
    .hang3 span {
        display: inline-block;
        width: 232px;
        height: 54px;
        line-height: 54px;
        background: #0070C8;
        border: 1px solid #BDDBFF;
        box-sizing: border-box;
        border-radius: 5px;
        text-align: center;
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        font-size: 16px;
        color: #FFFFFF;
    }
    
    .toast {
        position: fixed;
        z-index: 2000;
        left: 50%;
        top: 25%;
        transition: all .5s;
        -webkit-transform: translateX(-50%) translateY(-50%);
        -moz-transform: translateX(-50%) translateY(-50%);
        -ms-transform: translateX(-50%) translateY(-50%);
        -o-transform: translateX(-50%) translateY(-50%);
        transform: translateX(-50%) translateY(-50%);
        text-align: center;
        border-radius: 5px;
        color: #FFF;
        background: rgba(17, 17, 17, 0.7);
        height: 45px;
        line-height: 45px;
        padding: 0 15px;
        width: 100%;
    }
    
    .mx-calendar-content {
        width: 276px;
        height: 224px;
    }
    
    [v-cloak] {
        display: none;
    }
</style>

<body>
    <div id="app" v-cloak>
        <div class="toast" v-show="toastShow">
            {{toastText}}
        </div>
        <div class="hang"><input placeholder="请输入主题" v-model="votes.Name" /></div>
        <div class="hang">
            <select v-model="votes.Type">
            <option v-for="item in stateList" :value="item.value" :key="item.value" name="sendValue">{{
                item.label }}
            </option>
            </select>
        </div>
        <div class="hang"><input placeholder="请输入主题描述(可选)" /></div>
        <div style="margin:10px 0px;text-align: center">
            <date-picker v-if="curLanguleKey==='zh'" type="datetime" v-model="startTime" format="YYYY-MM-DD HH:mm:ss" lang="zh" confirm :placeholder="curLangule['key']"></date-picker>
            <date-picker v-if="curLanguleKey==='en'" type="datetime" v-model="startTime" format="YYYY-MM-DD HH:mm:ss" lang="en" confirm :placeholder="curLangule['key']"></date-picker>
        </div>
        <div style="margin:10px 0px;text-align: center">
            <date-picker v-if="curLanguleKey==='zh'" type="datetime" v-model="endTime" format="YYYY-MM-DD HH:mm:ss" lang="zh" confirm :placeholder="curLangule['key1']"></date-picker>
            <date-picker v-if="curLanguleKey==='en'" type="datetime" v-model="endTime" format="YYYY-MM-DD HH:mm:ss" lang="en" confirm :placeholder="curLangule['key1']"></date-picker>
        </div>
        <!-- <div class="hang"><input placeholder="请输入活动开始的高度" v-model="votes['Starting-height']" /></div>
        <div class="hang"><input placeholder="请输入活动结束的高度" v-model="votes['End-height']" /></div> -->
        <div class="hang2" v-for="(item,index) in xuanxiangArr">
            <span class="left">{{item.OptionID}}</span>
            <span class="middle">{{item.Name}}</span>
            <span class="right" @click="del(index)">删除</span>
        </div>
        <div class="hang1">
            <input placeholder="选项标识" class="left" v-model="xuanxiangObj.OptionID" /><input placeholder="选项的内容" class="right" v-model="xuanxiangObj.Name" /><span @click="add">添加</span>
        </div>

        <div class="hang3">
            <span @click="xiayibu">下一步</span>
        </div>
    </div>


    </div>
</body>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            zh: {
                title: 'Elastos 多签钱包',
                key: '开始日期',
                key1: '结束日期'
            },
            en: {
                title: 'Elastos Multi Sign Wallet',
                key: '开始日期',
                key1: '结束日期'
            },
            curLangule: {},
            schemeConfig: {
                "AppID": "f4d54cd97afa828a9705e38eb679fad564cf3adf4cecd1a5503498155969b07baaa4c4a016084c0f21e06c59e76c33929925052d7d0ae3cfc679a0fdf48ec23f",
                "AppName": encodeURIComponent("ELA Multi-sig Wallet"),
                "DID": "ipFFpL1JwPRQKfhmxak8r1wWEbdkJ3rXZu",
                "PublicKey": "035731ff69f8cfdcd9881e573143d71de2390b2e8e71fa14729e6b506f5d74939d",
                "RandomNumber": "123456789",
                "ReturnUrl": "",
                "RequestInfo": "Nickname"
            },
            schemeConfig1: {
                "AppID": "f4d54cd97afa828a9705e38eb679fad564cf3adf4cecd1a5503498155969b07baaa4c4a016084c0f21e06c59e76c33929925052d7d0ae3cfc679a0fdf48ec23f",
                "AppName": encodeURIComponent("ELA Multi-sig Wallet"),
                "DID": "ipFFpL1JwPRQKfhmxak8r1wWEbdkJ3rXZu",
                "PublicKey": "035731ff69f8cfdcd9881e573143d71de2390b2e8e71fa14729e6b506f5d74939d",
                "RequestedContent": "",
                "UseStatement": "didvote",
                "ReturnUrl": "",
            },
            showMask: false,
            toastText: "",
            toastShow: false,
            xuanxiangArr: [],
            xuanxiangObj: {
                OptionID: "",
                Name: "",
                Desc: ""
            },
            stateList: [{
                value: 'singleChoice',
                label: '单选题'
            }, {
                value: 'multipleChoice',
                label: '多选题'
            }],
            votes: {
                Name: "您认为早餐重要吗？",
                Desc: "",
                Type: "singleChoice",
                "Max-Selections": "",
                "Starting-height": "",
                "End-height": "",
                Options: []
            },
            startTime: new Date(),
            endTime: new Date(),
            curLanguleKey: ""
        },
        methods: {
            getUrlParam: function(name) {
                //正则表达式过滤
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                //正则规则
                var r = window.location.search.substr(1).match(reg);

                if (r != null) return decodeURI(r[2]);
                return null;
            },
            getAjax(url) {
                return new Promise((resovle, reject) => {
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        type: 'GET',
                        success: function(data) { //成功回调函数
                            resovle(data);
                        },
                        error: function(err) { //失败回调函数
                            reject(err);
                        }
                    });
                });
            },
            xiayibu() {
                this.votes["Starting-height-alias"] = parseInt((new Date(this.startTime).getTime() / 1000));
                this.votes["End-height-alias"] = parseInt((new Date(this.endTime).getTime() / 1000));
                if (this.votes["Starting-height-alias"] > this.votes["End-height-alias"]) {
                    this.toast("开始时间需要小于结束时间");
                    return;
                }
                this.votes["Starting-height"] = this.getBHeight(this.votes["Starting-height-alias"]);
                this.votes["End-height"] = this.getBHeight(this.votes["End-height-alias"]);
                this.votes.Options = _.cloneDeep(this.xuanxiangArr);
                this.votes['Max-Selections'] = this.votes.Options.length;
                var objStr = JSON.stringify(this.votes);
                console.log(JSON.stringify(this.votes));
                var url = this.buildSign(objStr);
                var turl = 'https://launch.elaphant.app?appName=ELA Multi-sig Wallet&autoRedirect=True&appTitle=ELA Multi-sig Wallet&redirectURL=' + encodeURIComponent(url);
                location.href = turl;
            },
            getBHeight(curTime) {
                return this.votes["Starting-height"] + (curTime - this.votes["Starting-height-alias"]) / 180;
            },
            buildSign(objStr) {
                this.schemeConfig1['RequestedContent'] = objStr;
                this.schemeConfig1['ReturnUrl'] = 'http://dev1.elapps.net/previewVote.html';
                var url = "elaphant://sign?";
                _.forEach(this.schemeConfig1, function(val, key, index) {
                    if (key === 'ReturnUrl' || key === 'RequestInfo' || key === 'RequestedContent') {
                        val = encodeURIComponent(val);
                    }
                    url += key + '=' + val + '&';
                });

                return url.substring(0, url.length - 1);
            },
            getLen2(str) {　　　　 //将中文替换成两个英文字符来统计
                return str.replace(/[^\x00-\xff]/g, "aa").length;
            },
            toast(str) {
                var v = this;
                v.toastText = str
                v.toastShow = true
                setTimeout(function() {
                    v.toastShow = false;
                }, 1500)
            },
            buildIdentity() {
                this.schemeConfig['ReturnUrl'] = 'http://dev1.elapps.net/createWallet.html';
                var url = "elaphant://identity?";
                _.forEach(this.schemeConfig, function(val, key, index) {
                    if (key === 'ReturnUrl' || key === 'RequestInfo') {
                        val = encodeURIComponent(val);
                    }
                    url += key + '=' + val + '&';
                });

                return url.substring(0, url.length - 1);
            },
            getLanugle: function() {
                this.curLangule = this.en;
                this.curLanguleKey = 'en';
                var JsSrc = (navigator.language || navigator.browserLanguage).toLowerCase();
                if (JsSrc.indexOf('zh') >= 0) {
                    // 假如浏览器语言是中文
                    this.curLanguleKey = 'zh';
                    this.curLangule = this.zh;
                } else if (JsSrc.indexOf('en') >= 0) {
                    this.curLangule = this.en;
                    this.curLanguleKey = 'en';
                } else {
                    // 假如浏览器语言是其它语言
                    this.curLangule = this.en;
                    this.curLanguleKey = 'en';
                }
            },
            create() {
                var url = this.buildIdentity();
                var turl = 'https://launch.elaphant.app?appName=ELA Multi-sig Wallet&autoRedirect=True&appTitle=ELA Multi-sig Wallet&redirectURL=' + encodeURIComponent(url);
                location.href = turl;
                //location.href = './createWallet.html';
            },
            add() {
                if (this.xuanxiangObj.OptionID == "") {
                    this.toast("请输入题号");
                    return false;
                }
                if (this.xuanxiangObj.Name == "") {
                    this.toast("请输入题型内容");
                    return false;
                }
                this.xuanxiangObj.OptionID = parseInt(this.xuanxiangObj.OptionID);
                var item = _.cloneDeep(this.xuanxiangObj);
                this.xuanxiangArr.push(item);
            },
            del(index) {
                this.xuanxiangArr.splice(index, 1);
            }
        },
        created: function() {

            this.xuanxiangArr = this.votes.Options;
            this.getAjax('https://idchain.elastos.org/api/v1/block/height').then((res) => {
                console.log("res===" + JSON.stringify(res));
                this.votes["Starting-height"] = res[0].height;
                this.startTime = new Date();
                this.endTime = new Date(new Date().getTime() + 1000 * 60 * 60 * 6);
                this.votes["Starting-height-alias"] = parseInt((new Date(this.startTime).getTime() / 1000));
                this.votes["End-height-alias"] = parseInt((new Date(this.endTime).getTime() / 1000));
                var height = this.getBHeight(this.votes["End-height-alias"]);
                this.votes["End-height"] = height;
            });
        },
        mounted() {
            this.getLanugle();
            document.title = this.curLangule["title"];
        }
    });
</script>

</html>